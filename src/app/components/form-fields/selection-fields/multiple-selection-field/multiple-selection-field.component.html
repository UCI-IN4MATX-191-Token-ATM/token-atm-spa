<div class="m-3">
    <label class="form-label">{{ label }}</label>
    <div class="d-flex align-items-center">
        <mat-form-field class="flex-grow-1" subscriptSizing="dynamic">
            <mat-select
                [(ngModel)]="value"
                multiple
                [disabled]="isReadOnly || isProcessing"
                [disableRipple]="true"
                [compareWith]="isEqual"
                (valueChange)="onSelectValueChange($event)"
            >
                <mat-option>
                    <ngx-mat-select-search [(ngModel)]="filterText" placeholderLabel=""></ngx-mat-select-search>
                </mat-option>
                <mat-optgroup
                    *ngIf="invalidOptions.length !== 0"
                    label="Invalid Options"
                    class="warn-color"
                    [hidden]="filteredInvalidOptionInds.size === 0"
                >
                    <mat-option
                        *ngFor="let option of invalidOptions; let i = index"
                        #matOption
                        [value]="option"
                        [hidden]="!filteredInvalidOptionInds.has(i)"
                        (onSelectionChange)="onInvalidOptionDeselected($event, matOption)"
                    >
                        {{ optionRenderer(option) }}
                    </mat-option>
                </mat-optgroup>
                <mat-divider *ngIf="filteredInvalidOptionInds.size !== 0" class="m-1"></mat-divider>
                <mat-option
                    *ngFor="let option of validOptions; let i = index"
                    [value]="option"
                    [hidden]="!filteredValidOptionInds.has(i)"
                >
                    {{ optionRenderer(option) }}
                </mat-option>
            </mat-select>
        </mat-form-field>
        <button
            type="button"
            class="btn btn-outline-dark ms-2"
            [disabled]="isReadOnly || isProcessing"
            (click)="refreshOptions()"
        >
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
    <p *ngIf="errorMessage" class="text-danger">{{ errorMessage }}</p>
</div>
